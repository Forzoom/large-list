!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue")):"function"==typeof define&&define.amd?define(["vue"],e):(t=t||self).LargeList=e(t.Vue)}(this,function(H){"use strict";function C(t){return null==t}H=H&&H.hasOwnProperty("default")?H.default:H;var e,s=(e="Object",function(t){return Object.prototype.toString.call(t)==="[object ".concat(e,"]")});function n(t,e,i){if(t>i[e[e.length-1]].top)return e.length-1;for(var n=0,a=e.length-1,h=Math.floor((n+a)/2);n+1<a;){var r=i[e[h]].top;if(r===t)return h;r<t?n=h:a=h,h=Math.floor((n+a)/2)}return h}return{name:"LargeList",props:{list:{type:Array,default:function(){return[]}},defaultItemHeight:{type:Number,default:200},defaultItemGap:{type:Number,default:10},preloadHeight:{type:Number,default:200},offsetTop:{type:Number,default:0},persistence:{},load:{}},data:function(){return{metaMap:{},startIndex:0,endIndex:0,containerHeight:0,pendingRefresh:!1}},computed:{idList:function(){return this.list.map(function(t){return t.id})},displayList:function(){return this.list.slice(this.startIndex,this.endIndex)}},watch:{"$props.list":function(t,e){var i=this.defaultItemHeight+this.defaultItemGap,n=this.containerHeight,a=!0,h=!1,r=void 0;try{for(var s,o=e[Symbol.iterator]();!(a=(s=o.next()).done);a=!0){var l=s.value;n-=this.metaMap[l.id].height}}catch(t){h=!0,r=t}finally{try{a||null==o.return||o.return()}finally{if(h)throw r}}for(var d=0,f=t.length;d<f;d++){var p=this.idList[d];if(C(this.metaMap[p])){var u=this.idList[d-1],c=0;this.metaMap[u]&&(c=this.metaMap[u].top+this.metaMap[u].height),H.set(this.metaMap,""+p,{top:c,height:i})}}var g=!0,m=!1,v=void 0;try{for(var y,x=t[Symbol.iterator]();!(g=(y=x.next()).done);g=!0){var I=y.value;n+=this.metaMap[I.id].height}}catch(t){m=!0,v=t}finally{try{g||null==x.return||x.return()}finally{if(m)throw v}}this.containerHeight=n;var M=this.$el;this.refresh(window.scrollY-(M?M.offsetTop+this.offsetTop:0))},endIndex:function(t,e){if(this.pendingRefresh)for(var i=e,n=Math.min(e+8,this.idList.length);i<n;i++){var a=this.idList[i-1];if(!C(a)){var h=this.idList[i];this.metaMap[h].top=this.metaMap[a].top+this.metaMap[a].height}}}},methods:{scrollCallback:function(){var t=this.$el;this.refresh(window.scrollY-(t?t.offsetTop+this.offsetTop:0))},refresh:function(t){var e=t+window.innerHeight+this.preloadHeight;t-=this.preloadHeight;var i=this.idList;this.startIndex=t<0||0===i.length?0:n(t,i,this.metaMap),this.endIndex=e<0||0===i.length?0:n(e,i,this.metaMap)+1},onHeightChange:function(t,e){var i=this.metaMap[e].height,n=this.metaMap[e].height=t+this.defaultItemGap;this.containerHeight+=n-i;var a=!1,h=!0,r=!1,s=void 0;try{for(var o,l=this.displayList[Symbol.iterator]();!(h=(o=l.next()).done);h=!0){var d=o.value;d.id!==e?a&&(this.metaMap[d.id].top+=n-i):a=!0}}catch(t){r=!0,s=t}finally{try{h||null==l.return||l.return()}finally{if(r)throw s}}this.pendingRefresh=!0}},created:function(){var t=null;if(this.load&&(t=this.load()))this.metaMap=t.metaMap,this.containerHeight=t.containerHeight,this.startIndex=t.startIndex,this.endIndex=t.endIndex;else{for(var e=0,i=0,n=this.idList.length;i<n;i++){var a=""+this.idList[i],h=this.defaultItemHeight+this.defaultItemGap;H.set(this.metaMap,a,{top:i*h,height:h}),e+=h}this.containerHeight=e}window.addEventListener("scroll",this.scrollCallback)},mounted:function(){var t=this;this.$nextTick(function(){t.scrollCallback()})},beforeDestroy:function(){window.removeEventListener("scroll",this.scrollCallback),this.persistence&&this.persistence({metaMap:this.metaMap,startIndex:this.startIndex,endIndex:this.endIndex,containerHeight:this.containerHeight})},render:function(t){var r=this,e=this.$scopedSlots.default,i=e?e({startIndex:this.startIndex,endIndex:this.endIndex}):[];return(i||[]).forEach(function(t){var e=t.componentInstance,i=t.componentOptions;if(e&&!e._events.heightChange?e._events.heightChange||e.$on("heightChange",r.onHeightChange):i?i.listeners?i.listeners.heightChange=r.onHeightChange:i.listeners={heightChange:r.onHeightChange}:t.data&&(t.data.on?t.data.on.heightChange=r.onHeightChange:t.data.on={heightChange:r.onHeightChange}),t.data){var n=t.data.style,a=t.componentOptions.propsData.id,h=r.metaMap[a].top+"px";n?"string"==typeof n?t.data.style=n+"; top: ".concat(h):s(n)&&(t.data.style.top=h,t.elm.style.top=h):t.data.style={top:h}}}),t("div",{class:"large-list",style:{height:this.containerHeight+"px"}},i)}}});
