!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue")):"function"==typeof define&&define.amd?define(["vue"],e):(t=t||self).LargeList=e(t.Vue)}(this,function(r){"use strict";function o(t){return null==t}r=r&&r.hasOwnProperty("default")?r.default:r;var e,d=(e="Object",function(t){return Object.prototype.toString.call(t)==="[object ".concat(e,"]")});function n(t,e,i){if(t>i[e[e.length-1]].top)return e.length-1;for(var n=0,a=e.length-1,s=Math.floor((n+a)/2);n+1<a;){var h=i[e[s]].top;if(h===t)return s;h<t?n=s:a=s,s=Math.floor((n+a)/2)}return s}return{name:"LargeList",props:{list:{type:Array,default:function(){return[]}},defaultItemHeight:{type:Number,default:200},defaultItemGap:{type:Number,default:10},preloadHeight:{type:Number,default:200},persistence:{},load:{}},data:function(){return{metaMap:{},startIndex:0,endIndex:0,containerHeight:0,pendingRefresh:!1}},computed:{idList:function(){return this.list.map(function(t){return t.id})},displayList:function(){return this.list.slice(this.startIndex,this.endIndex)}},watch:{"$props.list":function(t){for(var e=this.defaultItemHeight+this.defaultItemGap,i=0,n=t.length;i<n;i++){var a=this.idList[i];if(o(this.metaMap[a])){var s=this.idList[i-1];if(!s)continue;var h=0;h=this.metaMap[s]?this.metaMap[s].top+this.metaMap[s].height:0+this.defaultItemHeight,r.set(this.metaMap,""+a,{top:h,height:e}),this.containerHeight+=e}}},endIndex:function(t,e){if(this.pendingRefresh)for(var i=e,n=Math.min(e+8,this.idList.length);i<n;i++){var a=this.idList[i-1];if(!o(a)){var s=this.idList[i];this.metaMap[s].top=this.metaMap[a].top+this.metaMap[a].height}}}},methods:{scrollCallback:function(){var t=this.$el;this.refresh(window.scrollY-(t?t.offsetTop:0))},refresh:function(t){var e=t+window.innerHeight+this.preloadHeight;t-=this.preloadHeight;var i=this.idList;this.startIndex=t<0||0===i.length?0:n(t,i,this.metaMap),this.endIndex=e<0||0===i.length?0:n(e,i,this.metaMap)+1},onHeightChange:function(t,e){var i=this.metaMap[e].height,n=this.metaMap[e].height=t+this.defaultItemGap;this.containerHeight+=n-i;var a=!1,s=!0,h=!1,r=void 0;try{for(var o,d=this.displayList[Symbol.iterator]();!(s=(o=d.next()).done);s=!0){var l=o.value;l.id!==e?a&&(this.metaMap[l.id].top+=n-i):a=!0}}catch(t){h=!0,r=t}finally{try{s||null==d.return||d.return()}finally{if(h)throw r}}this.pendingRefresh=!0}},created:function(){var t=null;if(this.load&&(t=this.load()))this.metaMap=t.metaMap,this.containerHeight=t.containerHeight,this.startIndex=t.startIndex,this.endIndex=t.endIndex;else{for(var e=0,i=0,n=this.idList.length;i<n;i++){var a=""+this.idList[i],s=this.defaultItemHeight+this.defaultItemGap;r.set(this.metaMap,a,{top:i*s,height:s}),e+=s}this.containerHeight=e}window.addEventListener("scroll",this.scrollCallback)},mounted:function(){var t=this;this.$nextTick(function(){t.scrollCallback()})},beforeDestroy:function(){window.removeEventListener("scroll",this.scrollCallback),this.persistence&&this.persistence({metaMap:this.metaMap,startIndex:this.startIndex,endIndex:this.endIndex,containerHeight:this.containerHeight})},render:function(t){var h=this,e=this.$scopedSlots.default,i=e?e({startIndex:this.startIndex,endIndex:this.endIndex}):[];return(i||[]).forEach(function(t){var e=t.componentInstance,i=t.componentOptions;if(e&&!e._events.heightChange?e._events.heightChange||e.$on("heightChange",h.onHeightChange):i?i.listeners?i.listeners.heightChange=h.onHeightChange:i.listeners={heightChange:h.onHeightChange}:t.data&&(t.data.on?t.data.on.heightChange=h.onHeightChange:t.data.on={heightChange:h.onHeightChange}),t.data){var n=t.data.style,a=t.componentOptions.propsData.id,s=h.metaMap[a].top+"px";n?"string"==typeof n?t.data.style=n+"; top: ".concat(s):d(n)&&(t.data.style.top=s,t.elm.style.top=s):t.data.style={top:s}}}),t("div",{class:"large-list",style:{height:this.containerHeight+"px"}},i)}}});
